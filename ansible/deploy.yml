# ──────────────────────────────────────────────
# Deploy Playbook
# ──────────────────────────────────────────────
# Deploys the Flask API as a Docker container.
#
# Usage:
#   ansible-playbook -i hosts.ini deploy.yml
#
# What it does:
#   1. Clones/pulls the latest code from GitHub
#   2. Creates .env file on the server
#   3. Builds the Docker image
#   4. Stops and removes the old container (if running)
#   5. Starts a new container with the updated code
# ──────────────────────────────────────────────

---
- name: Deploy LBRCE Food Court API
  hosts: servers
  become: no # Run as normal user (docker group)

  vars:
    repo_url: "https://github.com/YOUR_ORG/lbrce-campus-food-court.git" # UPDATE THIS
    app_dir: "/home/{{ ansible_user }}/lbrce-campus-food-court"
    container_name: "lbrce-api-container"
    image_name: "lbrce-api"
    app_port: 5000

    # Environment variables — UPDATE THESE or use Ansible Vault for secrets
    supabase_url: "https://your-project.supabase.co"
    supabase_key: "your-service-role-key"
    telegram_bot_token: "your-bot-token"

  tasks:
    - name: Clone or pull latest code
      git:
        repo: "{{ repo_url }}"
        dest: "{{ app_dir }}"
        version: main
        force: yes

    - name: Create .env file for the API
      copy:
        dest: "{{ app_dir }}/api/.env"
        content: |
          SUPABASE_URL={{ supabase_url }}
          SUPABASE_KEY={{ supabase_key }}
          TELEGRAM_BOT_TOKEN={{ telegram_bot_token }}
          FLASK_ENV=production
          FLASK_PORT={{ app_port }}

    - name: Build Docker image
      command: docker build -t {{ image_name }} ./api
      args:
        chdir: "{{ app_dir }}"

    - name: Stop old container (ignore errors if not running)
      command: docker stop {{ container_name }}
      ignore_errors: yes

    - name: Remove old container (ignore errors if not exists)
      command: docker rm {{ container_name }}
      ignore_errors: yes

    - name: Start new container
      command: >
        docker run -d
        --name {{ container_name }}
        -p {{ app_port }}:{{ app_port }}
        --env-file {{ app_dir }}/api/.env
        --restart unless-stopped
        {{ image_name }}

    - name: Verify container is running
      command: docker ps --filter name={{ container_name }} --format "{{ '{{' }}.Status{{ '}}' }}"
      register: container_status

    - name: Show container status
      debug:
        msg: "Container status: {{ container_status.stdout }}"
